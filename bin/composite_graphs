#!/usr/bin/env ruby

require 'json'
require 'pp'
require 'byebug'
require 'nokogiri'
# require 'slim'
require 'erb'
require 'digest/sha1'
require 'open3'

require_relative "lib/common"
include Repository

HELP = <<EOF

Generates SVG diagrams for all composite KNARTS in the provided in the directory.

	USAGE: #{__FILE__} <directory>

	EXAMPLE:
		#{__FILE__} content

EOF


if(ARGV.length != 1)
	puts HELP
	exit 1
else
	# path = File.expand_path(ARGV[0])
	items = content_directory_to_item_tree(ARGV[0])
	items.each do |i|
		# puts "#{i['path']} #{i['mimeType']}"
		# puts i['mimeType']
		# byebug
		if COMPOSITE_MIME_TYPES.include?(i['mimeType'].to_s)
			path = i['path'].to_s
			doc = Nokogiri::XML(File.open(path))
			dot = generate_dot(doc)
			svg = "#{path}.svg"
			stdout_str, error_str, status =	Open3.capture3('dot', '-Tsvg', '-o', svg, stdin_data: dot)
		end
	end
	
	exit 0
end
